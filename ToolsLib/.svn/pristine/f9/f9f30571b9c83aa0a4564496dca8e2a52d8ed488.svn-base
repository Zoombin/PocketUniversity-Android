package com.mslibs.widget;

import java.io.File;
import java.util.Timer;
import java.util.TimerTask;

import android.app.Activity;
import android.app.AlertDialog;
import android.app.ProgressDialog;
import android.content.Context;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.pm.PackageManager.NameNotFoundException;
import android.net.Uri;
import android.os.Bundle;
import android.os.Environment;
import android.provider.MediaStore;
import android.util.DisplayMetrics;
import android.view.View;
import android.view.WindowManager;
import android.view.inputmethod.InputMethodManager;
import android.widget.EditText;

import com.ms.R;
import com.mslibs.utils.Preferences;
import com.mslibs.utils.VolleyLog;

public abstract class CActivity extends Activity {
	public Activity mActivity;
	public Context mContext;

	// UI效果变量
	private ProgressDialog dialog;
	private int dialogCount = 0;

	@Override
	public void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);

		mActivity = this;
		mContext = mActivity.getBaseContext();
	}

	public abstract void linkUiVar();

	public abstract void bindListener();

	public abstract void ensureUi();

	public void showProgress(String title, String message) {

		dialogCount++;
		VolleyLog.v("------------------» showProgress[%d]", dialogCount);

		if (null == mActivity || dialogCount > 1 || dialog != null)
			return;

		dialog = ProgressDialog.show(mActivity, mContext.getString(R.string.dialog_title),
				mContext.getString(R.string.dialog_message), true, true);

	}

	public void showProgress() {
		showProgress("正在获取内容", "请稍候...");
	}

	public void dismissProgress() {

		dialogCount--;
		VolleyLog.v("------------------» dismissProgress[%d]", dialogCount);

		if (dialogCount > 0 || dialog == null) {
			return;
		}

		try {
			dialog.dismiss();
			dialog = null;
		} catch (Exception e) {
			e.printStackTrace();
		}

	}

	public void startCameraIntent() {
		Intent intent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE);
		Uri mImageCaptureUri = Uri.fromFile(new File(Environment.getExternalStorageDirectory(),
				"tmp_upload.jpg"));
		intent.putExtra(MediaStore.EXTRA_OUTPUT, mImageCaptureUri);

		startActivityForResult(intent, Preferences.REQUEST_CODE.TAKE_PHOTO);
	}

	public void startGalleryIntent() {
		try {
			Intent intent = new Intent(Intent.ACTION_GET_CONTENT);
			intent.setType("image/*");
			startActivityForResult(intent, Preferences.REQUEST_CODE.GET_PHOTO);
		} catch (Exception ex) {

		}
	}

	public void BuildImageDialog(Context context) {

		AlertDialog.Builder builder = new AlertDialog.Builder(mActivity);
		builder.setTitle("什么方式上传图片呢?");
		builder.setPositiveButton("拍照上传", new DialogInterface.OnClickListener() {
			public void onClick(DialogInterface dialog, int whichButton) {
				startCameraIntent();
			}
		});
		builder.setNegativeButton("相册选择", new DialogInterface.OnClickListener() {
			public void onClick(DialogInterface dialog, int whichButton) {
				startGalleryIntent();

			}
		});
		builder.show();

	}

	public void hideSoftInput(View v) {
		VolleyLog.d("hideSoftInput");
		InputMethodManager inputManager = (InputMethodManager) getSystemService(Context.INPUT_METHOD_SERVICE);
		inputManager.hideSoftInputFromWindow(v.getWindowToken(),
				InputMethodManager.HIDE_NOT_ALWAYS);
	}

	// 打开软键盘
	public void openKeyboard() {
		Timer timer = new Timer();
		timer.schedule(new TimerTask() {
			@Override
			public void run() {
				InputMethodManager imm = (InputMethodManager) getSystemService(INPUT_METHOD_SERVICE);
				imm.toggleSoftInput(0, InputMethodManager.HIDE_NOT_ALWAYS);

			}
		}, 500);
	}

	// 关闭软键盘
	public void closeKeyboard(EditText et) {
		InputMethodManager imm = (InputMethodManager) getSystemService(INPUT_METHOD_SERVICE);
		imm.hideSoftInputFromWindow(et.getWindowToken(), 0);
	}

	// 获取密度
	public float getMetricsDensity() {
		final WindowManager wm = (WindowManager) mContext.getSystemService(Context.WINDOW_SERVICE);
		DisplayMetrics metrics = new DisplayMetrics();
		wm.getDefaultDisplay().getMetrics(metrics);
		return metrics.density;
	}

	public String getVersion() {
		String v = "";
		try {
			v = mContext.getPackageManager().getPackageInfo(mContext.getPackageName(), 0).versionName;
		} catch (NameNotFoundException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		return v;
	}
}
