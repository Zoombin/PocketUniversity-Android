package com.xyhui.activity;

import java.util.ArrayList;

import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.os.Bundle;
import android.text.TextUtils;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Button;
import android.widget.EditText;

import com.mslibs.utils.JSONUtils;
import com.mslibs.utils.NotificationsUtil;
import com.mslibs.utils.VolleyLog;
import com.xyhui.R;
import com.xyhui.api.Api;
import com.xyhui.api.CallBack;
import com.xyhui.types.City;
import com.xyhui.types.Response;
import com.xyhui.types.School;
import com.xyhui.types.Token;
import com.xyhui.utils.Params;
import com.xyhui.utils.PrefUtil;
import com.xyhui.widget.FLActivity;

public class SigninActivity extends FLActivity {

	private PuApp mainApp;
	private PrefUtil mPrefUtil;

	private int delayTimes = 0;
	private final int MAX_DELAY_TIMES = 10;

	/** 跳转到下一个Activity的延时时间 **/
	private final int DELAYED_GOTO_DURATION = 500;

	private Button btn_select_school;
	private Button btn_select_city;
	private EditText edit_email;
	private EditText edit_password;
	private Button btn_signin;

	private School school = null;

	private City city = null;

	@Override
	public void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_signin);

		mPrefUtil = new PrefUtil();
		mainApp = PuApp.get();

		linkUiVar();
		bindListener();
		ensureUi();
	}

	@Override
	public void linkUiVar() {
		btn_select_school = (Button) this.findViewById(R.id.btn_select_school);
		btn_select_city = (Button) this.findViewById(R.id.btn_select_city);
		edit_email = (EditText) findViewById(R.id.edit_email);
		edit_password = (EditText) findViewById(R.id.edit_password);
		btn_signin = (Button) findViewById(R.id.btn_signin);
	}

	@Override
	public void bindListener() {
		btn_select_city.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {
				closeKeyboard(edit_email);
				// 打开城市列表
				Intent intent = new Intent();
				intent.setClass(mActivity, CityListActivity.class);
				mActivity.startActivity(intent);
			}
		});

		btn_select_school.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {
				closeKeyboard(edit_email);
				// 打开学校列表
				Intent intent = new Intent();
				intent.setClass(mActivity, SchoolListActivity.class);
				mActivity.startActivity(intent);
			}
		});

		btn_signin.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {
				// 提交登录
				if (city == null) {
					NotificationsUtil.ToastBottomMsg(mContext, "请选择城市");
					return;
				}

				if (school == null) {
					NotificationsUtil.ToastBottomMsg(mContext, "请选择学校");
					return;
				}

				String email = edit_email.getText().toString().trim();
				String password = edit_password.getText().toString().trim();

				if (TextUtils.isEmpty(email)) {
					NotificationsUtil.ToastBottomMsg(mContext, "请填写学号");
					return;
				}

				if (TextUtils.isEmpty(password)) {
					NotificationsUtil.ToastBottomMsg(mContext, "请填写登录密码");
					return;
				}

				v.setEnabled(false);
				email = email + school.email;
				new Api(x, mActivity).login(email, password);
				closeKeyboard(edit_email);
			}
		});
	}

	@Override
	protected void onNewIntent(Intent intent) {
		super.onNewIntent(intent);
		edit_password.setText("");
	}

	private void testOneSchool() {

		ArrayList<School> schools = mainApp.getLocalDataMgr().getSchools();

		if (schools != null && !schools.isEmpty()) {
			schools.remove(0);

			ArrayList<School> citySchools = new ArrayList<School>();

			String cityId = mPrefUtil.getPreference(Params.LOCAL.CITYID);

			for (int i = 0; i < schools.size(); i++) {
				School school = schools.get(i);
				String schoolCityId = school.cityId;

				if (cityId.equals(schoolCityId) && citySchools.size() < 2) {
					citySchools.add(school);
				} else if (citySchools.size() >= 2) {
					break;
				}
			}

			if (citySchools.size() == 1) {
				school = citySchools.get(0);
				btn_select_school.setText(school.name);
				mPrefUtil.setPreference(Params.LOCAL.SCHOOLID, school.school);
			} else {
				btn_select_school.setText("选择所在学校");
			}
		}
	}

	CallBack x = new CallBack() {
		@Override
		public void onSuccess(String response) {
			Token token = JSONUtils.fromJson(response, Token.class);
			if (null != token) {
				if (token.isEmpty()) {
					btn_signin.setEnabled(true);
					String message = token.message;
					if (TextUtils.isEmpty(message)) {
						NotificationsUtil.ToastBottomMsg(mContext, "服务器返回错误");
					} else {
						NotificationsUtil.ToastBottomMsg(mContext, message);
					}
				} else {
					mPrefUtil.setPreference(Params.LOCAL.UID, token.uid);
					mPrefUtil.setPreference(Params.LOCAL.TOKEN, token.oauth_token);
					mPrefUtil.setPreference(Params.LOCAL.SECRET, token.oauth_token_secret);
					mainApp.getLocalDataMgr().setUserData(mActivity);
					new Api(callback, mActivity).getMobile(mainApp.getToken());
					initOrMain();
				}
			}
		}

		@Override
		public void onFailure(String message) {
			NotificationsUtil.ToastBottomMsg(mContext, message);
			btn_signin.setEnabled(true);
		}

		CallBack callback = new CallBack() {
			@Override
			public void onSuccess(String response) {
				VolleyLog.d("MOBILE: %s", mPrefUtil.getPreference(Params.LOCAL.MOBILE));
				Response result = JSONUtils.fromJson(response, Response.class);
				if (!TextUtils.isEmpty(result.response)) {
					mPrefUtil.setPreference(Params.LOCAL.MOBILE, result.response);
				} else {
					mPrefUtil.setPreference(Params.LOCAL.MOBILE, null);
				}

				VolleyLog.d("MOBILE: %s", mPrefUtil.getPreference(Params.LOCAL.MOBILE));
			}
		};
	};

	private void initOrMain() {
		btn_signin.postDelayed(new Runnable() {
			public void run() {
				VolleyLog.d("userDataArrived: %b", mainApp.getLocalDataMgr().userDataArrived());
				if (mainApp.getLocalDataMgr().userDataArrived()) {

					Intent intent = new Intent();
					if (!mainApp.getLocalDataMgr().isVerified()) {
						// 未验证
						intent.setClass(SigninActivity.this, AccountBindingActivity.class);
					} else if (!mainApp.getLocalDataMgr().isInited()) {
						// 未初始化
						intent.setClass(SigninActivity.this, UserInitActivity.class);
					} else {
						// 进入主程序
						intent.setClass(SigninActivity.this, MainActivity.class);
					}
					startActivity(intent);
				} else if (delayTimes > MAX_DELAY_TIMES) {
					NotificationsUtil.ToastTopMsg(mContext, "暂时无法获取数据");
					finish();
				} else {
					delayTimes++;
					initOrMain();
				}
			}
		}, DELAYED_GOTO_DURATION);
	}

	@Override
	public void ensureUi() {
		IntentFilter filter = new IntentFilter();
		filter.addAction("android.user.SCHOOL");
		filter.addAction("android.user.CITY");
		VolleyLog.v("Receiver Registed");
		registerReceiver(mEvtReceiver, filter);
		registerReceiver(mCityReceiver, filter);
	}

	public BroadcastReceiver mEvtReceiver = new BroadcastReceiver() {
		@Override
		public void onReceive(Context context, Intent intent) {
			if (intent.getAction().equals("android.user.SCHOOL")) {
				if (intent.hasExtra(Params.INTENT_EXTRA.SCHOOL)) {
					school = intent.getParcelableExtra(Params.INTENT_EXTRA.SCHOOL);
					btn_select_school.setText(school.name);
				}
			}
		}
	};

	public BroadcastReceiver mCityReceiver = new BroadcastReceiver() {
		@Override
		public void onReceive(Context context, Intent intent) {
			if (intent.getAction().equals("android.user.CITY")) {
				if (intent.hasExtra(Params.INTENT_EXTRA.CITY)) {
					city = intent.getParcelableExtra(Params.INTENT_EXTRA.CITY);
					btn_select_city.setText(city.city);

					testOneSchool();
				}
			}
		}
	};

	@Override
	public void onResume() {
		super.onResume();
		btn_signin.setEnabled(true);
	}

	@Override
	protected void onDestroy() {
		super.onDestroy();
		unregisterReceiver(mEvtReceiver);
		unregisterReceiver(mCityReceiver);
		VolleyLog.d("Receiver UnRegisted:");
	}
}
