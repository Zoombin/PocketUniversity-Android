package com.xyhui.activity.event;

import android.app.AlertDialog;
import android.content.DialogInterface;
import android.os.Bundle;
import android.os.Handler;
import android.text.TextUtils;

import com.mslibs.api.CallBack;
import com.mslibs.utils.JSONUtils;
import com.mslibs.utils.NotificationsUtil;
import com.xyhui.R;
import com.xyhui.activity.PuApp;
import com.xyhui.api.Api;
import com.xyhui.types.Response;
import com.xyhui.utils.MediaPlayerUtils;
import com.xyhui.utils.Preferences;
import com.xyhui.utils.ShakeDetector;
import com.xyhui.utils.ShakeDetector.OnShakeListener;
import com.xyhui.widget.FLActivity;

public class EventLuckyActivity extends FLActivity {
	private PuApp mainApp;

	private final int TIME_INTERVAL = 2000;

	private MediaPlayerUtils mMpUtils;

	// 防止快速摇动时连续调用相关监听器的功能
	private boolean mShaked = false;

	private boolean mDialogShowing = false;

	private String mEventId;
	private LuckyUser mEventLuckyUser;

	ShakeDetector mShakeDetector;
	OnShakeListener mOnShakeListener = new OnShakeListener() {

		@Override
		public void onShake() {
			if (!mShaked) {
				mShaked = true;
				mMpUtils.reset();
				mMpUtils.play("shake.wav", true);
				mHandler.postDelayed(new Runnable() {
					@Override
					public void run() {
						mMpUtils.reset();
						mShaked = false;
						showProgress();
						new Api(eventLuckyCB).eventLucky(mainApp.getToken(), mEventId);
					}
				}, TIME_INTERVAL);
			}
		}
	};

	Handler mHandler = new Handler();

	@Override
	public void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		mainApp = PuApp.get();

		setContentView(R.layout.activity_event_lucky);

		if (getIntent().hasExtra(Preferences.INTENT_EXTRA.EVENTID)) {
			mEventId = getIntent().getStringExtra(Preferences.INTENT_EXTRA.EVENTID);
		}

		ensureUi();
	}

	@Override
	public void linkUiVar() {

	}

	@Override
	public void bindListener() {

	}

	@Override
	public void ensureUi() {
		mShakeDetector = new ShakeDetector(mContext);
		mShakeDetector.registerOnShakeListener(mOnShakeListener);
	}

	@Override
	protected void onStart() {
		super.onStart();
		mMpUtils = new MediaPlayerUtils(mContext);
	}

	@Override
	protected void onResume() {
		super.onResume();
		if (!mDialogShowing) {
			mShakeDetector.start();
		}
	}

	@Override
	protected void onPause() {
		super.onPause();
		mShakeDetector.stop();
	}

	@Override
	protected void onStop() {
		super.onStop();
		mMpUtils.onStop();
	}

	@Override
	protected void onDestroy() {
		super.onDestroy();
		mShakeDetector.unregisterOnShakeListener(mOnShakeListener);
	}

	private void showGiftDialog(String luckyUserName) {
		mShakeDetector.stop();
		mDialogShowing = true;
		mMpUtils.play("shake_match.wav", false);
		new AlertDialog.Builder(mActivity).setTitle("抽签结果").setMessage("您摇到了" + luckyUserName)
				.setPositiveButton("不过滤继续", new DialogInterface.OnClickListener() {
					public void onClick(DialogInterface dialog, int whichButton) {
						mShakeDetector.start();
						mDialogShowing = false;
					}
				}).setNegativeButton("过滤后继续", new DialogInterface.OnClickListener() {
					public void onClick(DialogInterface dialog, int whichButton) {
						showProgress();
						new Api(eventLuckyConfirmCB).eventLuckyConfirm(mainApp.getToken(),
								mEventLuckyUser.id);
						mShakeDetector.start();
						mDialogShowing = false;
					}
				}).setCancelable(false).show();
	}

	CallBack eventLuckyCB = new CallBack() {
		@Override
		public void onSuccess(String response) {
			dismissProgress();
			mEventLuckyUser = JSONUtils.fromJson(response, LuckyUser.class);

			if (null != mEventLuckyUser) {
				if (mEventLuckyUser.status == 0) {
					NotificationsUtil.ToastBottomMsg(mContext, "人已抽完");
				} else if (null != mEventLuckyUser && mEventLuckyUser.status == 1
						&& !TextUtils.isEmpty(mEventLuckyUser.realname)) {
					showGiftDialog(mEventLuckyUser.realname);
				}
			}
		}
	};

	CallBack eventLuckyConfirmCB = new CallBack() {
		@Override
		public void onSuccess(String response) {
			dismissProgress();
			Response r = JSONUtils.fromJson(response, Response.class);

			if (null != r && 0 == r.status) {
				NotificationsUtil.ToastBottomMsg(mContext, r.msg);
			}
		}
	};

	class LuckyUser {
		int status;
		String id;
		String realname;
	}
}
