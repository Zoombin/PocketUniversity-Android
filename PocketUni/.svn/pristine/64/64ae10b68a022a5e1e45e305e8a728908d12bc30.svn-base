package com.xyhui.activity;

import java.util.Random;

import android.app.AlertDialog;
import android.app.DownloadManager;
import android.content.Context;
import android.content.DialogInterface;
import android.content.Intent;
import android.net.Uri;
import android.os.Bundle;
import android.os.Environment;
import android.text.TextUtils;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.LinearLayout;
import android.widget.TextView;

import com.mslibs.api.CallBack;
import com.mslibs.utils.JSONUtils;
import com.mslibs.utils.NotificationsUtil;
import com.mslibs.utils.VolleyLog;
import com.xyhui.R;
import com.xyhui.activity.more.AboutActivity;
import com.xyhui.activity.more.AccountManageActivity;
import com.xyhui.activity.more.QRCardViewActivity;
import com.xyhui.activity.more.QRCodeScanActivity;
import com.xyhui.activity.weibo.MessageActivity;
import com.xyhui.activity.weibo.UserHomePageActivity;
import com.xyhui.api.Api;
import com.xyhui.types.Response;
import com.xyhui.utils.AccountUtils;
import com.xyhui.utils.Preferences;
import com.xyhui.widget.FLTabActivity;

public class TabMoreActivity extends FLTabActivity {

	private final String HELP_URL = "http://pocketuni.net/puhelp.html";

	LinearLayout account_layout;
	LinearLayout homepage_layout;
	LinearLayout qrcard_layout;
	LinearLayout qrscan_layout;
	LinearLayout message_layout;
	LinearLayout question_layout;
	LinearLayout about_layout;
	LinearLayout update_layout;
	TextView text_version;
	LinearLayout signout_layout;

	PuApp mApplication;

	@Override
	public void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_tab_more);

		mApplication = (PuApp) getApplication();

		linkUiVar();
		bindListener();
		ensureUi();
	}

	@Override
	public void linkUiVar() {
		account_layout = (LinearLayout) findViewById(R.id.account_layout);
		homepage_layout = (LinearLayout) findViewById(R.id.homepage_layout);
		qrcard_layout = (LinearLayout) findViewById(R.id.qrcard_layout);
		qrscan_layout = (LinearLayout) findViewById(R.id.qrscan_layout);
		message_layout = (LinearLayout) findViewById(R.id.message_layout);
		question_layout = (LinearLayout) findViewById(R.id.question_layout);
		about_layout = (LinearLayout) findViewById(R.id.about_layout);
		update_layout = (LinearLayout) findViewById(R.id.update_layout);
		text_version = (TextView) findViewById(R.id.text_version);
		signout_layout = (LinearLayout) findViewById(R.id.signout_layout);
	}

	@Override
	public void bindListener() {

		account_layout.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {
				// 账号管理
				Intent intent = new Intent();
				intent.setClass(mActivity, AccountManageActivity.class);
				mActivity.startActivity(intent);
			}
		});
		homepage_layout.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {
				// 个人首页
				PuApp mApplication = (PuApp) mActivity.getApplication();
				String user_id = mApplication.getPreference(Preferences.LOCAL.UID);

				Intent intent = new Intent();
				intent.setClass(mActivity, UserHomePageActivity.class);
				intent.putExtra(Preferences.INTENT_EXTRA.USER_ID, user_id);
				mActivity.startActivity(intent);
			}
		});
		qrcard_layout.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {
				// 二维码名片
				Intent intent = new Intent();
				intent.setClass(mActivity, QRCardViewActivity.class);
				mActivity.startActivity(intent);
			}
		});
		qrscan_layout.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {
				// 二维码扫描
				Intent intent = new Intent();
				intent.setClass(mActivity, QRCodeScanActivity.class);
				mActivity.startActivity(intent);
			}
		});

		message_layout.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {
				// 账号消息
				Intent intent = new Intent();
				intent.setClass(mActivity, MessageActivity.class);
				mActivity.startActivity(intent);
			}
		});
		question_layout.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {
				// 常见问题
				Intent intent = new Intent();
				intent.setClass(mActivity, WebViewActivity.class);
				intent.putExtra(Preferences.INTENT_EXTRA.WEBVIEW_TITLE, "常见问题");
				intent.putExtra(Preferences.INTENT_EXTRA.WEBVIEW_URL, HELP_URL);
				mActivity.startActivity(intent);
			}
		});
		about_layout.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {
				// 关于PocketUni
				Intent intent = new Intent();
				intent.setClass(mActivity, AboutActivity.class);
				mActivity.startActivity(intent);
			}
		});
		update_layout.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {
				// 检测新版本
				showProgress();
				new Api(callback).getVersion();
			}
		});
		signout_layout.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {
				// 注销账号
				new AlertDialog.Builder(mActivity).setTitle("确定要注销吗?")
						.setPositiveButton("确定", new DialogInterface.OnClickListener() {
							public void onClick(DialogInterface dialog, int whichButton) {
								AccountUtils.logout(mActivity);
							}
						}).setNegativeButton("取消", new DialogInterface.OnClickListener() {
							public void onClick(DialogInterface dialog, int whichButton) {

							}
						}).show();
			}
		});
	}

	@Override
	public void ensureUi() {
		// 显示当前版本号
		String v = getVersion();
		text_version.setText("当前版本：" + v);
	}

	CallBack callback = new CallBack() {
		@Override
		public void onSuccess(String response) {
			dismissProgress();
			Response r = JSONUtils.fromJson(response, Response.class);

			if (r == null) {
				noUpdate();
				return;
			}

			String version = r.version;
			final String url = r.response;
			String current_version = getVersion();

			VolleyLog.d("version: %s \n current_version: %s", version, current_version);

			if (TextUtils.isEmpty(version) || TextUtils.isEmpty(url)
					|| current_version.compareTo(version) >= 0) {

				VolleyLog.d("no need update");
				noUpdate();
			} else {
				new AlertDialog.Builder(TabMoreActivity.this).setTitle("升级应用程序")
						.setMessage("程序有新的版本可用, 现在就升级吗?")
						.setPositiveButton("立即升级", new DialogInterface.OnClickListener() {
							public void onClick(DialogInterface dialog, int whichButton) {

								Random ran = new Random(System.currentTimeMillis());

								String filename = "xyhui." + ran.nextInt(100000) + ".apk";

								DownloadManager.Request request = new DownloadManager.Request(Uri
										.parse(url));
								request.setDescription("Pocketuni Android手机客户端");
								request.setTitle("开始下载新版本");

								String downloaddir = Environment.DIRECTORY_DOWNLOADS;

								if (downloaddir.contains("://")) {
									downloaddir = "download";
								}

								VolleyLog.d("url=%s dir=%s filename=%s", url, downloaddir,
										filename);

								Environment.getExternalStoragePublicDirectory(downloaddir).mkdir();

								request.setDestinationInExternalPublicDir(downloaddir, filename);

								DownloadManager manager = (DownloadManager) mActivity
										.getSystemService(Context.DOWNLOAD_SERVICE);

								manager.enqueue(request);

								String message = "开始下载新版本";
								NotificationsUtil.ToastLongMessage(mContext, message);
							}
						}).setNeutralButton("暂不升级", new DialogInterface.OnClickListener() {
							public void onClick(DialogInterface dialog, int whichButton) {
								dialog.cancel();
								noUpdate();
							}
						}).show();
			}
		}

		@Override
		public void onFailure(String message) {
			noUpdate();
		}
	};

	void noUpdate() {
		String message = "当前是最新版本";
		NotificationsUtil.ToastBottomMsg(mContext, message);
	}
}
