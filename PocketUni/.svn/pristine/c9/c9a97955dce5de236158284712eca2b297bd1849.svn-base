package com.xyhui.activity.app;

import android.app.AlertDialog;
import android.content.DialogInterface;
import android.content.DialogInterface.OnClickListener;
import android.content.Intent;
import android.graphics.drawable.AnimationDrawable;
import android.os.Bundle;
import android.os.Handler;
import android.view.KeyEvent;
import android.widget.ImageView;
import android.widget.TextView;

import com.mslibs.utils.JSONUtils;
import com.mslibs.utils.NotificationsUtil;
import com.xyhui.R;
import com.xyhui.activity.PuApp;
import com.xyhui.activity.weibo.UserHomePageActivity;
import com.xyhui.api.Api;
import com.xyhui.api.CallBack;
import com.xyhui.utils.MediaPlayerUtils;
import com.xyhui.utils.Params;
import com.xyhui.utils.ShakeDetector;
import com.xyhui.utils.ShakeDetector.OnShakeListener;
import com.xyhui.widget.FLActivity;

public class ShakeActivity extends FLActivity {
	private final int TIME_INTERVAL = 2500;
	private MediaPlayerUtils mMpUtils;

	private TextView tv_left_times;
	private ImageView shake_bg;

	// 用来标记一次摇晃的结束,默认为已经结束
	private boolean mShakeFinished = true;

	private ShakedData mShakedData;
	private ShakeData mShakeData;

	private Handler mHandler = new Handler();

	private ShakeDetector mShakeDetector;

	private AnimationDrawable mAnim;

	private OnShakeListener mOnShakeListener = new OnShakeListener() {

		@Override
		public void onShake() {
			if (mShakeFinished) {
				mShakeFinished = false;
				mMpUtils.reset();
				mMpUtils.play("shake.wav", true);
				mAnim.stop();
				mAnim.start();
				mHandler.postDelayed(new Runnable() {
					@Override
					public void run() {
						mMpUtils.reset();
						mAnim.stop();
						showProgress();
						new Api(shakedCB, mActivity).shakeYY(PuApp.get().getToken());
					}
				}, TIME_INTERVAL);
			}
		}
	};

	@Override
	public void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_app_shake);
		ensureUi();
		linkUiVar();
	}

	@Override
	public void linkUiVar() {
		tv_left_times = (TextView) findViewById(R.id.tv_left_times);
		shake_bg = (ImageView) findViewById(R.id.shake_bg);
		mAnim = (AnimationDrawable) shake_bg.getBackground();
	}

	@Override
	public void bindListener() {

	}

	@Override
	public void ensureUi() {
		mShakeDetector = new ShakeDetector(mContext);
		mShakeDetector.registerOnShakeListener(mOnShakeListener);
		mMpUtils = new MediaPlayerUtils(mContext);
	}

	@Override
	protected void onResume() {
		super.onResume();
		// (如果没处理完当前的摇晃就进入了其他页面,回来的时候应该接着处理,而不是执行下面的代码)
		if (mShakeFinished) {
			new Api(shakeCB, mActivity).shakeStatus(PuApp.get().getToken());
			mShakeFinished = false;
		}

		try {
			mShakeDetector.start();
		} catch (UnsupportedOperationException e) {
			NotificationsUtil.ToastBottomMsg(mContext, "请重新进入");
			finish();
		}
	}

	@Override
	protected void onPause() {
		super.onPause();
		mShakeDetector.stop();
	}

	@Override
	protected void onDestroy() {
		super.onDestroy();
		mShakeDetector.unregisterOnShakeListener(mOnShakeListener);
		mMpUtils.onStop();
	}

	CallBack shakeCB = new CallBack() {
		@Override
		public void onSuccess(String response) {
			mShakeData = JSONUtils.fromJson(response, ShakeData.class);

			if (null != mShakeData) {
				tv_left_times.setText(String.format("今日剩余次数：%d", mShakeData.rest));
				if (mShakeData.rest > 0 && mShakeData.cost > 0) {
					showGiftDialog(0, mShakeData.cost);
				} else {
					mShakeFinished = true;
				}
			}
		}

		@Override
		public void onFailure(String message) {
			NotificationsUtil.ToastBottomMsg(mContext, "网络异常");
			mShakeFinished = true;
		}
	};

	CallBack shakedCB = new CallBack() {
		@Override
		public void onSuccess(String response) {
			dismissProgress();

			mShakedData = JSONUtils.fromJson(response, ShakedData.class);

			if (null != mShakedData) {
				if (0 == mShakedData.status) {
					NotificationsUtil.ToastBottomMsg(mContext, mShakedData.msg);
					mShakeFinished = true;
				} else if (1 == mShakedData.status) {
					tv_left_times.setText(String.format("今日剩余次数：%d", mShakedData.rsp.rest));
					showGiftDialog(mShakedData.data.type, 0);
				}
			}
		}

		@Override
		public void onFailure(String message) {
			dismissProgress();
			NotificationsUtil.ToastBottomMsg(mContext, "网络异常");
			mShakeFinished = true;
		}
	};

	private void showGiftDialog(final int type, int nextCost) {
		if (0 != type) {
			mMpUtils.play("shake_match.wav", false);
		}

		String title = "", message = "";

		switch (type) {
		case 0:
			title = "注意";
			message = String.format("你今天的免费摇奖次数已经用完了，如果继续,系统将会扣除你%.2f个PU币，继续吗？", nextCost / 100.0);
			break;
		case 1:
			title = "再加把劲吧！";
			message = "这次啥都没摇到";
			break;
		case 2:
			title = "恭喜!";
			message = String.format("你获得了%.2f个PU币", mShakedData.data.win / 100.0);
			break;
		case 3:
			title = "运气不错哦！";
			message = String.format("你摇到了一个来自%s的%s生", mShakedData.data.school,
					mShakedData.data.sex);
			break;
		}

		AlertDialog.Builder builder = new AlertDialog.Builder(mActivity).setTitle(title)
				.setMessage(message).setPositiveButton("继续", new OnClickListener() {
					public void onClick(DialogInterface dialog, int whichButton) {
						if (0 != type && null != mShakedData && null != mShakedData.rsp
								&& mShakedData.rsp.cost > 0 && mShakedData.rsp.rest > 0) {
							showGiftDialog(0, mShakedData.rsp.cost);
						} else {
							mShakeFinished = true;
						}
					}
				}).setNegativeButton("不摇了", new OnClickListener() {
					public void onClick(DialogInterface dialog, int whichButton) {
						finish();
					}
				}).setCancelable(false);

		if (3 == type) {
			builder.setNeutralButton("去看看", new OnClickListener() {
				@Override
				public void onClick(DialogInterface dialog, int which) {
					mShakeFinished = true;
					// 打开个人主页
					Intent intent = new Intent();
					intent.setClass(mActivity, UserHomePageActivity.class);
					intent.putExtra(Params.INTENT_EXTRA.USER_ID, mShakedData.data.win + "");
					mActivity.startActivity(intent);
				}
			});
		}

		builder.create().show();
	}

	@Override
	public boolean onKeyDown(int keyCode, KeyEvent event) {
		if (keyCode == KeyEvent.KEYCODE_BACK) {
			if (!mShakeFinished) {
				return true;
			}
		}
		return super.onKeyDown(keyCode, event);
	}

	class ShakedData {
		int status;
		String msg;
		Gift data;
		ShakeData rsp;

		class Gift {
			int type;
			int win;
			String realname;
			String school;
			String sex;
		}
	}

	class ShakeData {
		int rest;// 剩余次数，
		int times;// 当前次数
		int cost;// 费用
	}
}
