package com.xyhui.activity.event;

import android.app.AlertDialog;
import android.content.DialogInterface;
import android.graphics.drawable.AnimationDrawable;
import android.os.Bundle;
import android.os.Handler;
import android.text.TextUtils;
import android.view.KeyEvent;
import android.widget.ImageView;

import com.mslibs.utils.JSONUtils;
import com.mslibs.utils.NotificationsUtil;
import com.xyhui.R;
import com.xyhui.activity.PuApp;
import com.xyhui.api.Api;
import com.xyhui.api.CallBack;
import com.xyhui.types.Response;
import com.xyhui.utils.MediaPlayerUtils;
import com.xyhui.utils.Preferences;
import com.xyhui.utils.ShakeDetector;
import com.xyhui.utils.ShakeDetector.OnShakeListener;
import com.xyhui.widget.FLActivity;

public class EventLuckyActivity extends FLActivity {
	private PuApp mainApp;

	private final int TIME_INTERVAL = 2500;

	private MediaPlayerUtils mMpUtils;

	private ImageView lucky_bg;
	private AnimationDrawable mAnim;

	// 防止快速摇动时连续调用相关监听器的功能
	private boolean mShakeFinished = true;

	private String mEventId;
	private LuckyUser mEventLuckyUser;

	ShakeDetector mShakeDetector;
	OnShakeListener mOnShakeListener = new OnShakeListener() {

		@Override
		public void onShake() {
			if (mShakeFinished) {
				mShakeFinished = false;
				mMpUtils.reset();
				mMpUtils.play("shake.wav", true);
				mAnim.stop();
				mAnim.start();
				mHandler.postDelayed(new Runnable() {
					@Override
					public void run() {
						mMpUtils.reset();
						mAnim.stop();
						showProgress();
						new Api(eventLuckyCB, mActivity).eventLucky(mainApp.getToken(), mEventId);
					}
				}, TIME_INTERVAL);
			}
		}
	};

	Handler mHandler = new Handler();

	@Override
	public void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		mainApp = PuApp.get();

		setContentView(R.layout.activity_event_lucky);

		if (getIntent().hasExtra(Preferences.INTENT_EXTRA.EVENTID)) {
			mEventId = getIntent().getStringExtra(Preferences.INTENT_EXTRA.EVENTID);
		}

		linkUiVar();
		bindListener();
		ensureUi();
	}

	@Override
	public void linkUiVar() {
		lucky_bg = (ImageView) findViewById(R.id.lucky_bg);
		mAnim = (AnimationDrawable) lucky_bg.getBackground();
	}

	@Override
	public void bindListener() {

	}

	@Override
	public void ensureUi() {
		mShakeDetector = new ShakeDetector(mContext);
		mShakeDetector.registerOnShakeListener(mOnShakeListener);
		mMpUtils = new MediaPlayerUtils(mContext);
	}

	@Override
	protected void onResume() {
		super.onResume();
		mShakeDetector.start();
	}

	@Override
	protected void onPause() {
		super.onPause();
		mShakeDetector.stop();
	}

	@Override
	protected void onDestroy() {
		super.onDestroy();
		mMpUtils.onStop();
		mShakeDetector.unregisterOnShakeListener(mOnShakeListener);
	}

	private void showGiftDialog(String luckyUserName) {
		mMpUtils.play("shake_match.wav", false);
		new AlertDialog.Builder(mActivity).setTitle("抽签结果").setMessage("您摇到了" + luckyUserName)
				.setPositiveButton("不过滤继续", new DialogInterface.OnClickListener() {
					public void onClick(DialogInterface dialog, int whichButton) {
						mShakeFinished = true;
					}
				}).setNegativeButton("过滤后继续", new DialogInterface.OnClickListener() {
					public void onClick(DialogInterface dialog, int whichButton) {
						showProgress();
						new Api(eventLuckyConfirmCB, mActivity).eventLuckyConfirm(
								mainApp.getToken(), mEventLuckyUser.id);
						mShakeFinished = true;
					}
				}).setCancelable(false).show();
	}

	CallBack eventLuckyCB = new CallBack() {
		@Override
		public void onSuccess(String response) {
			dismissProgress();
			mEventLuckyUser = JSONUtils.fromJson(response, LuckyUser.class);

			if (null != mEventLuckyUser) {
				if (mEventLuckyUser.status == 0) {
					mShakeFinished = true;
					NotificationsUtil.ToastBottomMsg(mContext, "人已抽完");
				} else if (null != mEventLuckyUser && mEventLuckyUser.status == 1
						&& !TextUtils.isEmpty(mEventLuckyUser.realname)) {
					showGiftDialog(mEventLuckyUser.realname);
				}
			}
		}

		@Override
		public void onFailure(String response) {
			dismissProgress();
			NotificationsUtil.ToastBottomMsg(mContext, "网络异常");
			mShakeFinished = true;
		}
	};

	CallBack eventLuckyConfirmCB = new CallBack() {
		@Override
		public void onSuccess(String response) {
			dismissProgress();
			Response r = JSONUtils.fromJson(response, Response.class);

			if (null != r) {
				if (0 == r.status) {
					NotificationsUtil.ToastBottomMsg(mContext, r.msg);
				} else if (1 == r.status) {
					NotificationsUtil.ToastBottomMsg(mContext, "成功过虑!");
				}
			}
		}

		@Override
		public void onFailure(String response) {
			dismissProgress();
			NotificationsUtil.ToastBottomMsg(mContext, "网络异常");
		}
	};

	@Override
	public boolean onKeyDown(int keyCode, KeyEvent event) {
		if (keyCode == KeyEvent.KEYCODE_BACK) {
			if (!mShakeFinished) {
				return true;
			}
		}
		return super.onKeyDown(keyCode, event);
	}

	class LuckyUser {
		int status;
		String id;
		String realname;
	}
}
