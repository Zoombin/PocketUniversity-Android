package com.xyhui.activity.more;

import android.app.AlertDialog;
import android.content.DialogInterface;
import android.content.Intent;
import android.os.Bundle;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Button;
import android.widget.LinearLayout;
import android.widget.TextView;

import com.mslibs.api.CallBack;
import com.mslibs.utils.JSONUtils;
import com.xyhui.R;
import com.xyhui.activity.PuApp;
import com.xyhui.api.Api;
import com.xyhui.types.User;
import com.xyhui.utils.AccountUtils;
import com.xyhui.utils.Preferences;
import com.xyhui.widget.FLActivity;

public class AccountManageActivity extends FLActivity {
	Button btn_back;
	TextView text_nickname;
	TextView text_credit;
	TextView text_total_score;
	LinearLayout btn_signout;

	LinearLayout baseinfo_layout;
	LinearLayout cellphone_layout;
	LinearLayout password_layout;

	PuApp mApplication;

	protected User user;

	private AccountUtils mAccountUtils;

	@Override
	public void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_account);

		mApplication = (PuApp) getApplication();
		linkUiVar();
		bindListener();
		ensureUi();
	}

	@Override
	public void linkUiVar() {
		btn_back = (Button) findViewById(R.id.btn_back);
		text_nickname = (TextView) findViewById(R.id.text_nickname);
		text_credit = (TextView) findViewById(R.id.text_credit);
		text_total_score = (TextView) findViewById(R.id.text_total_score);
		btn_signout = (LinearLayout) findViewById(R.id.btn_signout);
		baseinfo_layout = (LinearLayout) findViewById(R.id.baseinfo_layout);
		cellphone_layout = (LinearLayout) findViewById(R.id.cellphone_layout);
		password_layout = (LinearLayout) findViewById(R.id.password_layout);
	}

	@Override
	public void bindListener() {
		btn_back.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {
				// 关闭返回
				finish();
			}
		});

		baseinfo_layout.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {

				if (user == null) {
					return;
				}
				// 账号信息修改
				Intent intent = new Intent();
				intent.setClass(mActivity, AccountBaseinfoActivity.class);
				intent.putExtra(Preferences.INTENT_EXTRA.USER, user);
				mActivity.startActivity(intent);
			}
		});

		cellphone_layout.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {
				// 手机绑定
				Intent intent = new Intent();
				intent.setClass(mActivity, PhoneBindingActivity.class);
				mActivity.startActivity(intent);
			}
		});

		password_layout.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {
				if (user == null) {
					return;
				}
				// 账号密码修改
				Intent intent = new Intent();
				intent.setClass(mActivity, PasswordModifyActivity.class);
				mActivity.startActivity(intent);
			}
		});

		btn_signout.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {
				// 注销账号

				new AlertDialog.Builder(mActivity).setTitle("确定要注销吗?")
						.setPositiveButton("确定", new DialogInterface.OnClickListener() {
							public void onClick(DialogInterface dialog, int whichButton) {
								mAccountUtils.logout(mActivity);
							}
						}).setNegativeButton("取消", new DialogInterface.OnClickListener() {
							public void onClick(DialogInterface dialog, int whichButton) {
							}
						}).show();
			}
		});
	}

	@Override
	public void ensureUi() {
		mAccountUtils = new AccountUtils();
	}

	@Override
	protected void onResume() {
		super.onResume();

		showProgress();
		new Api(callback).myinfo(mApplication.getToken());
	}

	CallBack callback = new CallBack() {
		@Override
		public void onSuccess(String response) {
			dismissProgress();
			user = JSONUtils.fromJson(response, User.class);

			if (user != null) {
				text_nickname.setText("账号昵称：" + user.uname);
				text_credit.setText("实践学分：" + user.school_event_credit);
				text_total_score.setText("活动积分：" + user.school_event_score_used);
			}
		}
	};

}
