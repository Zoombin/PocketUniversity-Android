package com.xyhui.activity;

import java.util.ArrayList;

import android.app.AlertDialog;
import android.content.DialogInterface;
import android.content.Intent;
import android.os.Bundle;
import android.os.Handler;
import android.text.TextUtils;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.ImageView;
import android.widget.TextView;

import com.google.gson.reflect.TypeToken;
import com.mslibs.utils.JSONUtils;
import com.mslibs.utils.NotificationsUtil;
import com.mslibs.utils.VolleyLog;
import com.xyhui.R;
import com.xyhui.api.Api;
import com.xyhui.api.CallBack;
import com.xyhui.types.City;
import com.xyhui.types.Response;
import com.xyhui.types.School;
import com.xyhui.utils.DownloadImpl;
import com.xyhui.utils.Params;
import com.xyhui.utils.PrefUtil;
import com.xyhui.widget.FLActivity;

public class LoadingActivity extends FLActivity {

	/** 跳转到下一个Activity的延时时间 **/
	private final int DELAYED_GOTO_DURATION = 500;

	private int delayTimes = 0;
	private final int MAX_DELAY_TIMES = 15;

	private String mNewVersionUrl;
	String mCurrent_version;

	private Handler mHandler = new Handler();

	private boolean isFirstLaunch = true;

	private ImageView img_loading_bg;
	private TextView tv_versioninfo;

	private PrefUtil mPrefUtil;

	// 版本信息
	private Response versionInfo;

	@Override
	public void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_loading);
		mPrefUtil = new PrefUtil();

		PuApp.get().getLocalDataMgr().clearAllData();
		isFirstLaunch = mPrefUtil.getBoolPreference(Params.LOCAL.FIRSTRUN);
		linkUiVar();
		bindListener();
		ensureUi();
	}

	@Override
	public void linkUiVar() {
		img_loading_bg = (ImageView) findViewById(R.id.img_loading_bg);
		tv_versioninfo = (TextView) findViewById(R.id.tv_versioninfo);
	}

	@Override
	public void bindListener() {

	}

	@Override
	public void ensureUi() {
		mCurrent_version = getVersion();
		tv_versioninfo.setText(String.format("V %s", mCurrent_version));

		// 检测是否首次启动 默认 isFirstLaunch = true
		if (isFirstLaunch) {
			FirstLaunch();
		} else {
			img_loading_bg.setVisibility(View.GONE);
			update();
		}

		new Api(cityListCB, mActivity).getCitys();
		new Api(schoolListCB, mActivity).getSchools();

		if (PuApp.get().isLogon()) {
			PuApp.get().getLocalDataMgr().setEventCats(mActivity);
			PuApp.get().getLocalDataMgr().setCourseCats(mActivity);
			PuApp.get().getLocalDataMgr().setGroupCats(mActivity);
			PuApp.get().getLocalDataMgr().setUserData(mActivity);
		}
	}

	public void FirstLaunch() {
		img_loading_bg.setVisibility(View.VISIBLE);
		img_loading_bg.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {
				mPrefUtil.setPreference(Params.LOCAL.FIRSTRUN, false);
				update();
			}
		});
	}

	public void signinOrMain() {
		mHandler.postDelayed(new Runnable() {
			public void run() {
				VolleyLog.d("*******signinOrMain******* \n DelayTimes= %d", delayTimes);
				if (PuApp.get().isLogon() && PuApp.get().getLocalDataMgr().allDataArrived()) {
					Intent intent = new Intent();
					if (!PuApp.get().getLocalDataMgr().isVerified()) {
						intent.setClass(LoadingActivity.this, AccountBindingActivity.class);
					} else if (!PuApp.get().getLocalDataMgr().isInited()) {
						intent.setClass(LoadingActivity.this, UserInitActivity.class);
					} else {
						intent.setClass(LoadingActivity.this, MainActivity.class);
					}
					startActivity(intent);
					finish();
				} else if (!PuApp.get().isLogon()
						&& PuApp.get().getLocalDataMgr().citySchoolArrived()) {
					Intent intent = new Intent(LoadingActivity.this, SigninActivity.class);
					startActivity(intent);
					finish();
				} else if (delayTimes > MAX_DELAY_TIMES) {
					NotificationsUtil.ToastTopMsg(mContext, "暂时无法获取数据");
					finish();
				} else {
					delayTimes++;
					signinOrMain();
				}

			}
		}, DELAYED_GOTO_DURATION);
	}

	public void update() {

		new Api(callback, mActivity).getVersion();

	}

	CallBack callback = new CallBack() {
		@Override
		public void onSuccess(String response) {
			versionInfo = JSONUtils.fromJson(response, Response.class);
			checkVersion();
		}

		@Override
		public void onFailure(String message) {
			finish();
		}
	};

	private void checkVersion() {
		if (versionInfo == null) {
			signinOrMain();
			return;
		}

		String version = versionInfo.version;
		mNewVersionUrl = versionInfo.response;

		if (TextUtils.isEmpty(version) || TextUtils.isEmpty(mNewVersionUrl)
				|| mCurrent_version.compareTo(version) >= 0) {
			signinOrMain();
		} else {
			showDownloadDialog();
		}
	}

	private void showDownloadDialog() {
		new AlertDialog.Builder(LoadingActivity.this).setTitle("升级应用程序")
				.setMessage("程序有新的版本可用, 现在就升级吗?")
				.setPositiveButton("立即升级", new DialogInterface.OnClickListener() {
					public void onClick(DialogInterface dialog, int whichButton) {
						signinOrMain();
						DownloadImpl download = new DownloadImpl(mContext, mNewVersionUrl,
								"PocketUni客户端", String.format("PocketUni_%s.apk",
										versionInfo.version));
						download.startDownload();
					}
				}).setNeutralButton("暂不升级", new DialogInterface.OnClickListener() {
					public void onClick(DialogInterface dialog, int whichButton) {
						signinOrMain();
					}
				}).setCancelable(false).show();
	}

	CallBack schoolListCB = new CallBack() {
		@Override
		public void onSuccess(String response) {
			mPrefUtil.setPreference(Params.LOCAL.SCHOOLLIST, response);

			ArrayList<School> schools = JSONUtils.fromJson(response,
					new TypeToken<ArrayList<School>>() {
					});

			if (null != schools) {
				School allschool = new School();
				allschool.name = "选择学校";
				allschool.school = "0";

				schools.add(0, allschool);
			}

			PuApp.get().getLocalDataMgr().setSchools(schools);
		}
	};

	CallBack cityListCB = new CallBack() {
		@Override
		public void onSuccess(String response) {
			mPrefUtil.setPreference(Params.LOCAL.CITYLIST, response);

			ArrayList<City> citys = JSONUtils.fromJson(response, new TypeToken<ArrayList<City>>() {
			});

			if (null != citys) {
				City allCity = new City();
				allCity.city = "选择城市";
				allCity.id = "0";
				citys.add(0, allCity);
			}

			PuApp.get().getLocalDataMgr().setCitys(citys);
		}
	};
}
