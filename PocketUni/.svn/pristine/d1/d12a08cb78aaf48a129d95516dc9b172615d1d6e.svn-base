package com.xyhui.activity;

import java.util.ArrayList;

import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.text.TextUtils;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Button;
import android.widget.EditText;

import com.mslibs.utils.JSONUtils;
import com.mslibs.utils.NotificationsUtil;
import com.mslibs.utils.VolleyLog;
import com.xyhui.R;
import com.xyhui.api.Api;
import com.xyhui.api.CallBack;
import com.xyhui.types.City;
import com.xyhui.types.Response;
import com.xyhui.types.School;
import com.xyhui.types.Token;
import com.xyhui.utils.Params;
import com.xyhui.utils.PrefUtil;
import com.xyhui.widget.FLActivity;

public class SigninActivity extends FLActivity {

	private final String CLIENT_ANDROID = "1";

	private PrefUtil mPrefUtil;

	private int mDelayTimes = 0;
	private final int MAX_DELAY_TIMES = 10;

	/** 跳转到下一个Activity的延时时间 **/
	private final int DELAYED_GOTO_DURATION = 500;

	private Button btn_select_school;
	private Button btn_select_city;
	private EditText edit_email;
	private EditText edit_password;
	private Button btn_signin;

	private School mSchool;

	private City mCity;

	@Override
	public void init() {
		mPrefUtil = new PrefUtil();
	}

	@Override
	public void linkUiVar() {
		setContentView(R.layout.activity_signin);

		btn_select_school = (Button) findViewById(R.id.btn_select_school);
		btn_select_city = (Button) findViewById(R.id.btn_select_city);
		edit_email = (EditText) findViewById(R.id.edit_email);
		edit_password = (EditText) findViewById(R.id.edit_password);
		btn_signin = (Button) findViewById(R.id.btn_signin);
	}

	@Override
	public void bindListener() {
		btn_select_city.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {
				closeKeyboard(edit_email);
				// 打开城市列表
				Intent intent = new Intent();
				intent.setClass(mActivity, CityListActivity.class);
				startActivity(intent);
			}
		});

		btn_select_school.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {
				if (null == mCity) {
					NotificationsUtil.ToastTopMsg(mActivity, "请先选择城市");
					return;
				}

				closeKeyboard(edit_email);
				// 打开学校列表
				Intent intent = new Intent();
				intent.setClass(mActivity, SchoolListActivity.class);
				startActivity(intent);
			}
		});

		btn_signin.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {
				// 提交登录
				if (mCity == null) {
					NotificationsUtil.ToastBottomMsg(mActivity, "请选择城市");
					return;
				}

				if (mSchool == null) {
					NotificationsUtil.ToastBottomMsg(mActivity, "请选择学校");
					return;
				}

				String email = edit_email.getText().toString().trim();
				String password = edit_password.getText().toString().trim();

				if (TextUtils.isEmpty(email)) {
					NotificationsUtil.ToastBottomMsg(mActivity, "请填写学号");
					return;
				}

				if (TextUtils.isEmpty(password)) {
					NotificationsUtil.ToastBottomMsg(mActivity, "请填写登录密码");
					return;
				}

				v.setEnabled(false);
				email = email + mSchool.email;
				new Api(x, mActivity).login(email, password, CLIENT_ANDROID);
				closeKeyboard(edit_email);
			}
		});
	}

	private void testOneSchool() {

		ArrayList<School> schools = PuApp.get().getLocalDataMgr().getSchools();

		if (schools != null && !schools.isEmpty()) {
			schools.remove(0);

			ArrayList<School> citySchools = new ArrayList<School>();

			String cityId = mPrefUtil.getPreference(Params.LOCAL.CITYID);

			for (int i = 0; i < schools.size(); i++) {
				School school = schools.get(i);
				String schoolCityId = school.cityId;

				if (cityId.equals(schoolCityId) && citySchools.size() < 2) {
					citySchools.add(school);
				} else if (citySchools.size() >= 2) {
					break;
				}
			}

			if (citySchools.size() == 1) {
				mSchool = citySchools.get(0);
				btn_select_school.setText(mSchool.name);
				mPrefUtil.setPreference(Params.LOCAL.SCHOOLID, mSchool.school);
			} else {
				btn_select_school.setText("选择所在学校");
			}
		}
	}

	CallBack x = new CallBack() {
		@Override
		public void onSuccess(String response) {
			Token token = JSONUtils.fromJson(response, Token.class);
			if (null != token) {
				if (token.isEmpty()) {
					btn_signin.setEnabled(true);
					String message = token.message;
					if (TextUtils.isEmpty(message)) {
						NotificationsUtil.ToastBottomMsg(mActivity, "服务器返回错误");
					} else {
						NotificationsUtil.ToastBottomMsg(mActivity, message);
					}
				} else {
					mPrefUtil.setPreference(Params.LOCAL.UID, token.uid);
					mPrefUtil.setPreference(Params.LOCAL.TOKEN, token.oauth_token);
					mPrefUtil.setPreference(Params.LOCAL.SECRET, token.oauth_token_secret);
					mPrefUtil.setPreference(Params.LOCAL.UNAME, edit_email.getText().toString()
							.trim());

					// JPushInterface.setAlias(PuApp.get(), token.uid, new TagAliasCallback() {
					// @Override
					// public void gotResult(int arg0, String arg1, Set<String> arg2) {
					// VolleyLog.e("ErrorCode: %d \n Alias: %s \n Tags: %s", arg0, arg1,
					// arg2.toString());
					// }
					// });

					PuApp.get().getLocalDataMgr().setUserData(mActivity);
					new Api(callback, mActivity).getMobile(PuApp.get().getToken());
					initOrMain();
				}
			}
		}

		@Override
		public void onFailure(String message) {
			NotificationsUtil.ToastBottomMsg(mActivity, message);
			btn_signin.setEnabled(true);
		}

		CallBack callback = new CallBack() {
			@Override
			public void onSuccess(String response) {
				VolleyLog.d("MOBILE: %s", mPrefUtil.getPreference(Params.LOCAL.MOBILE));
				Response result = JSONUtils.fromJson(response, Response.class);
				if (!TextUtils.isEmpty(result.response)) {
					mPrefUtil.setPreference(Params.LOCAL.MOBILE, result.response);
				} else {
					mPrefUtil.setPreference(Params.LOCAL.MOBILE, null);
				}

				VolleyLog.d("MOBILE: %s", mPrefUtil.getPreference(Params.LOCAL.MOBILE));
			}
		};
	};

	private void initOrMain() {
		btn_signin.postDelayed(new Runnable() {
			public void run() {
				VolleyLog
						.d("userDataArrived: %b", PuApp.get().getLocalDataMgr().userDataArrived());
				if (PuApp.get().getLocalDataMgr().userDataArrived()) {

					Intent intent = new Intent();
					if (!PuApp.get().getLocalDataMgr().isVerified()) {
						// 未验证
						intent.setClass(SigninActivity.this, AccountBindingActivity.class);
					} else if (!PuApp.get().getLocalDataMgr().isInited()) {
						// 未初始化
						intent.setClass(SigninActivity.this, UserInitActivity.class);
					} else {
						// 进入主程序
						intent.setClass(SigninActivity.this, NewFeatureActivity.class);
					}
					startActivity(intent);
					finish();
				} else if (mDelayTimes > MAX_DELAY_TIMES) {
					NotificationsUtil.ToastTopMsg(mActivity, "暂时无法获取数据");
				} else {
					mDelayTimes++;
					initOrMain();
				}
			}
		}, DELAYED_GOTO_DURATION);
	}

	@Override
	public void ensureUi() {
		IntentFilter filter = new IntentFilter();
		filter.addAction("android.user.SCHOOL");
		filter.addAction("android.user.CITY");
		VolleyLog.v("Receiver Registed");
		registerReceiver(mEvtReceiver, filter);
		registerReceiver(mCityReceiver, filter);

		String cityName = mPrefUtil.getPreference(Params.LOCAL.CITYNAME);
		String cityId = mPrefUtil.getPreference(Params.LOCAL.CITYID);
		if (null != cityName && null != cityId) {
			mCity = new City(cityId, cityName);
			btn_select_city.setText(mCity.city);
		}

		String schoolName = mPrefUtil.getPreference(Params.LOCAL.SCHOOLNAME);
		String schoolId = mPrefUtil.getPreference(Params.LOCAL.SCHOOLID);
		String schoolEmail = mPrefUtil.getPreference(Params.LOCAL.SCHOOLEMAIL);
		if (null != schoolName && null != schoolId && null != schoolEmail) {
			mSchool = new School();
			mSchool.name = schoolName;
			mSchool.school = schoolId;
			mSchool.email = schoolEmail;

			btn_select_school.setText(mSchool.name);
		}

		String uName = mPrefUtil.getPreference(Params.LOCAL.UNAME);
		if (null != uName) {
			edit_email.setText(uName);
		}
	}

	public BroadcastReceiver mEvtReceiver = new BroadcastReceiver() {
		@Override
		public void onReceive(Context context, Intent intent) {
			if (intent.getAction().equals("android.user.SCHOOL")) {
				if (intent.hasExtra(Params.INTENT_EXTRA.SCHOOL)) {
					mSchool = intent.getParcelableExtra(Params.INTENT_EXTRA.SCHOOL);
					btn_select_school.setText(mSchool.name);
				}
			}
		}
	};

	public BroadcastReceiver mCityReceiver = new BroadcastReceiver() {
		@Override
		public void onReceive(Context context, Intent intent) {
			if (intent.getAction().equals("android.user.CITY")) {
				if (intent.hasExtra(Params.INTENT_EXTRA.CITY)) {
					mCity = intent.getParcelableExtra(Params.INTENT_EXTRA.CITY);
					btn_select_city.setText(mCity.city);

					testOneSchool();
				}
			}
		}
	};

	@Override
	public void onResume() {
		super.onResume();
		btn_signin.setEnabled(true);
	}

	@Override
	protected void onDestroy() {
		super.onDestroy();
		unregisterReceiver(mEvtReceiver);
		unregisterReceiver(mCityReceiver);
		VolleyLog.d("Receiver UnRegisted:");
	}
}
