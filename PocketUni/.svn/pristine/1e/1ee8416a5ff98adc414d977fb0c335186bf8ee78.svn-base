package com.xyhui.activity.weibo;

import java.util.Timer;
import java.util.TimerTask;

import android.os.Bundle;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Button;
import android.widget.EditText;
import android.widget.ListView;
import android.widget.TextView;

import com.mslibs.api.CallBack;
import com.mslibs.utils.NotificationsUtil;
import com.mslibs.widget.CListView;
import com.xyhui.R;
import com.xyhui.activity.PuApp;
import com.xyhui.api.Api;
import com.xyhui.types.Message;
import com.xyhui.utils.Preferences;
import com.xyhui.widget.FLActivity;

public class ChatDetailListActivity extends FLActivity {
	Button btn_back;

	ListView message_item_listview;
	ChatDetailList mMessageItemListView;

	TextView navbar_TitleText;

	EditText edit_message;

	Button btn_send;

	private Message message;
	private String mMsgUid;
	private String mOtherUserName;
	private String mListId;

	private PuApp mainApp;
	Timer mTimer;

	@Override
	public void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_message_list);

		if (getIntent().hasExtra(Preferences.INTENT_EXTRA.MESSAGE)) {
			message = getIntent().getParcelableExtra(Preferences.INTENT_EXTRA.MESSAGE);
		} else if (getIntent().hasExtra(Preferences.INTENT_EXTRA.MESSAGE_ID)) {
			mMsgUid = getIntent().getStringExtra(Preferences.INTENT_EXTRA.MESSAGE_ID);
			mOtherUserName = getIntent().getStringExtra(Preferences.INTENT_EXTRA.USERNAME);
		} else {
			finish();
			return;
		}

		mainApp = (PuApp) getApplication();

		linkUiVar();
		bindListener();
		ensureUi();
	}

	@Override
	public void linkUiVar() {
		navbar_TitleText = (TextView) findViewById(R.id.navbar_TitleText);
		btn_back = (Button) findViewById(R.id.btn_back);

		message_item_listview = (ListView) findViewById(R.id.message_item_listview);

		edit_message = (EditText) findViewById(R.id.edit_message);
		btn_send = (Button) findViewById(R.id.btn_send);
	}

	@Override
	public void bindListener() {
		btn_back.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {
				// 关闭返回
				finish();
			}
		});

		btn_send.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {
				// 发送私信
				String content = edit_message.getText().toString();
				String uid;
				if (content.length() > 0) {
					if (null != mMsgUid) {
						uid = mMsgUid;
					} else {
						uid = message.talk_uid;
					}
					new Api(callback).sendmessage(mainApp.getToken(), uid, content);
				}
			}
		});
	}

	CallBack callback = new CallBack() {
		@Override
		public void onSuccess(String response) {

			if (response.contains("false")) {
				NotificationsUtil.ToastBottomMsg(mContext, "发送失败");
			} else if (mMessageItemListView != null) {
				mListId = response;
				mMessageItemListView.setMsgId(mListId);
				mMessageItemListView.refreshListViewStart();
				edit_message.setText("");
			}
		}
	};

	@Override
	public void ensureUi() {
		String otherUserName = null;

		if (null == mMsgUid) {
			mMessageItemListView = new ChatDetailList(message_item_listview, mActivity,
					message.list_id);
			otherUserName = message.talk_uname;
		} else {
			mMessageItemListView = new ChatDetailList(message_item_listview, mActivity, mListId);
			otherUserName = mOtherUserName;
		}

		navbar_TitleText.setText("与" + otherUserName + "的对话");
	}

	@Override
	protected void onResume() {
		super.onResume();
		mTimer = new Timer();
		mTimer.scheduleAtFixedRate(new TimerTask() {
			@Override
			public void run() {
				btn_back.post(new Runnable() {
					@Override
					public void run() {
						if (mMessageItemListView.actionType == CListView.IDLE)
							mMessageItemListView.refreshListViewStart();
					}
				});
			}
		}, 4000, 4000);
	}

	@Override
	protected void onPause() {
		super.onPause();
		mTimer.cancel();
	}
}
