package com.xyhui.activity.app;

import android.text.TextUtils;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Button;
import android.widget.TextView;

import com.mslibs.utils.JSONUtils;
import com.mslibs.utils.NotificationsUtil;
import com.mslibs.widget.CActivity;
import com.xyhui.R;
import com.xyhui.activity.PuApp;
import com.xyhui.api.Api;
import com.xyhui.api.BaseApi;
import com.xyhui.api.CallBack;
import com.xyhui.utils.Params;
import com.xyhui.utils.ShareSDKUtil;
import com.xyhui.widget.FLActivity;

public class TrainViewActivity extends FLActivity {
	Button btn_back;
	Button btn_collect;
	Button btn_share;

	CourseInfo course;

	TextView text_notice;

	private String courseid = null;

	@Override
	public void init() {
		if (getIntent().hasExtra(Params.INTENT_EXTRA.COURSEID)) {
			courseid = getIntent().getStringExtra(Params.INTENT_EXTRA.COURSEID);
		} else {
			finish();
			return;
		}
	}

	@Override
	public void linkUiVar() {
		setContentView(R.layout.activity_train_course_view);

		btn_back = (Button) findViewById(R.id.btn_back);

		btn_collect = (Button) findViewById(R.id.btn_collect);
		btn_share = (Button) findViewById(R.id.btn_share);
		text_notice = (TextView) findViewById(R.id.text_notice);
	}

	@Override
	public void bindListener() {
		btn_back.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {
				// 关闭返回
				finish();
			}
		});

		btn_collect.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {
				showProgress();
				btn_collect.setEnabled(false);
				if (1 == course.collect) {
					new Api(collectCB, mActivity).cancelCollect(PuApp.get().getToken(), course.id);
				} else {
					new Api(collectCB, mActivity).collect(PuApp.get().getToken(), course.id);
				}
			}
		});

		btn_share.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {
				String content = "分享培训课程:【" + course.title + "】";
				ShareSDKUtil.showShare(mActivity, false, content, null, null);
			}
		});
	}

	CallBack collectCB = new CallBack() {

		@Override
		public void onSuccess(String response) {
			((CActivity) mActivity).dismissProgress();
			btn_collect.setEnabled(true);
			String res = BaseApi.decodeUnicode(response);
			NotificationsUtil.ToastBottomMsg(mActivity, res.substring(1, res.length() - 1));
			if (!TextUtils.isEmpty(response)) {
				if (1 == course.collect) {
					course.collect = 0;
					btn_collect.setText("收藏");
				} else {
					course.collect = 1;
					btn_collect.setText("已收藏");
				}
			}
		}

		@Override
		public void onFailure(String message) {
			super.onFailure(message);
			((CActivity) mActivity).dismissProgress();
			btn_collect.setEnabled(true);
		}
	};

	@Override
	public void ensureUi() {
		showProgress();
		new Api(callback, mActivity).course(PuApp.get().getToken(), courseid);
	}

	CallBack callback = new CallBack() {
		@Override
		public void onSuccess(String response) {
			dismissProgress();
			course = JSONUtils.fromJson(response, CourseInfo.class);

			if (course != null) {
				if (0 == course.collect) {
					btn_collect.setText("收藏");
				} else {
					btn_collect.setText("已收藏");
				}
				text_notice.setText(course.getNotice());
			}
		}
	};

	private static class CourseInfo {
		String id;
		String title;
		String description;
		String address;
		String cost;
		String contact;
		String classTime;
		String sTime;
		String eTime;
		String deadline;
		int collect;

		public String getNotice() {
			String result = "";

			if (!TextUtils.isEmpty(title)) {
				result += "课程名称：" + title;
			}

			if (!TextUtils.isEmpty(address)) {
				result += "\n上课地点：" + address;
			}

			if (!TextUtils.isEmpty(classTime)) {
				result += "\n上课时间：" + classTime;
			}

			if (!TextUtils.isEmpty(deadline)) {
				result += "\n报名截止时间：" + deadline;
			}

			if (!TextUtils.isEmpty(sTime)) {
				result += "\n开始时间：" + sTime;
			}

			if (!TextUtils.isEmpty(eTime)) {
				result += "\n结束时间：" + eTime;
			}

			if (!TextUtils.isEmpty(sTime)) {
				result += "\n价格：" + cost;
			}

			if (!TextUtils.isEmpty(sTime)) {
				result += "\n联系电话：" + contact;
			}

			if (!TextUtils.isEmpty(description)) {
				result += "\n\n\n课程介绍：" + description;
			}

			return result;
		}
	}
}
